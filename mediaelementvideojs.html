<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer" />
    <link href="https://vjs.zencdn.net/7.17.0/video-js.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="./assets/js/subtitles-octopus.js"></script>
    <script src="https://vjs.zencdn.net/7.17.0/video.js"></script>
</head>

<body>
    <div id="video-container" class="video-js vjs-default-skin"></div>

    <script>
        $(document).ready(function() {
            $.getJSON("dados.json", function(data) {
                var video = data.video;
                var videoElement = '<video id="player-demo" class="video-js vjs-default-skin" width="800" height="480" controls preload="none" poster="' + video.poster + '">';

                videoElement += '<source type="' + video.type + '" src="' + video.source + '" />';
                $.each(video.tracks, function(index, track) {
                    videoElement += '<track src="' + track.src + '" srclang="' + track.srclang + '" label="' + track.label + '" kind="' + track.kind + '" type="' + track.type + '">';
                });
                videoElement += '</video>';
                $('#video-container').append(videoElement);

                var baseUrl = getBaseUrl();
                videojs("player-demo", {}, function() {
                    var player = this;
                    player.on('loadedmetadata', function() {
                        player.play();
                    });
                    player.on('loadedmetadata', function() {
                        var tracks = player.textTracks();
                        tracks.on('change', function() {
                            console.log('Charging Track ' + player.currentCaption().src);
                            if (player.currentCaption().src !== null) {
                                var subUrl = player.currentCaption().src.replace(/^\.\//, baseUrl + '/');
                                if (window.octopusInstance) {
                                    window.octopusInstance.setTrackByUrl(subUrl);
                                } else if (SubtitlesOctopus) {
                                    var options = {
                                        video: player.el(),
                                        subUrl: subUrl,
                                        fonts: [baseUrl + '/fonts/CabinCondensed-Regular.ttf', baseUrl + '/fonts/SourceSansPro-SemiBold.ttf'],
                                        //onReady: onReadyFunction,
                                        debug: true,
                                        workerUrl: baseUrl + '/assets/js/subtitles-octopus-worker.js',
                                        legacyWorkerUrl: baseUrl + '/assets/js/subtitles-octopus-worker-legacy.js'
                                    };
                                    window.octopusInstance = new SubtitlesOctopus(options);
                                }
                            } else {
                                if (SubtitlesOctopus || window.octopusInstance) {
                                    console.log('Disable Track ' + player.currentCaption());
                                    window.octopusInstance.freeTrack();
                                }
                            }
                        });
                    });
                });
            });
        });

        function getBaseUrl() {
            var getUrl = window.location;
            var baseUrl = getUrl.protocol + "//" + getUrl.host + "/" + getUrl.pathname.split('/')[1];
            return baseUrl;
        }
    </script>
</body>

</html>
